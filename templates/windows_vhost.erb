<% @vhosts.each do |server, port_config| %>
<% port_config.each do |port, config| %>
<%- config_merged = @vhost_defaults[port].merge(config) -%>
<VirtualHost *:<%= port %>>
 <% config_merged.each do |key, value| -%>
 <%- if key != 'Directory' -%>
 <%= key %> <%= value %>
 <%- else -%>
 <%- dirs_merged = @vhost_directory_defaults.merge(value) -%>
 <%- dirs_merged['Directory'].each do |dir, dir_value| -%>
 <Directory "<%= dir %>">
   <%= dir %> <%= dir_value %>
 <%- end -%>
 </Directory>
 <%- end -%>
 <%- end -%>
</VirtualHost>
<% end %>
<% end %>
