<% @vhosts.each do |server, port_config| %>
<% port_config.each do |port, config| %>
<%- config_merged = @vhost_defaults[port].merge(config) -%>
<VirtualHost *:<%= port %>>
 <% config_merged.each do |key, value| %>
 <% if key != 'Directory' -%>
 <%= key %> <%= value %>
 <% else -%>
 <%- dirs = @vhost_directory_defaults.merge(value) -%>
 <%- dirs.each do |dir, dir_value| -%>
   <%= dir %> <%= dir_value %>
 <%- end -%>
 <%- end -%>
 </Directory>
 <%- end -%>
</VirtualHost>
<% end %>
<% end %>
