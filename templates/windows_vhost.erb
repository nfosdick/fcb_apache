<% @vhosts.each do |server, port_config| %>
<%- ports_merged = @vhost_defaults.deep_merge(@vhosts[server]) -%>
<%= ports_merged %>
<% port_config.each do |port, config| %>
<VirtualHost *:<%= port %>>
 DocumentRoot "<%= config['DocumentRoot'] %>"
 ServerName <%= server %>
 <% config['Directory'].each do |dir, dir_config| %>
 <Directory "<%= dir %>">
 <%- dirs = @vhost_directory_defaults.merge(dir_config) -%>
 <%- dirs.each do |key, value| -%>
   <%= key %> <%= value %>
 <%- end -%>
 </Directory>
 <%- end -%>
</VirtualHost>
<% end %>
<% end %>

