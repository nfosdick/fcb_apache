<% @vhosts.each do |server, port_config| %>
<% port_config.each do |port, config| %>
<%- ports = @vhost_defaults.merge(config) -%>
<VirtualHost *:<%= port %>>
 DocumentRoot "<%= ports['DocumentRoot'] %>"
 ServerName <%= server %>
 <% config['Directory'].each do |dir, dir_config| %>
 <Directory "<%= dir %>">
 <%- dirs = @vhost_directory_defaults.merge(dir_config) -%>
 <%- dirs.each do |key, value| -%>
   <%= key %> <%= value %>
 <%- end -%>
 </Directory>
 <%- end -%>
</VirtualHost>
<% end %>
<% end %>

