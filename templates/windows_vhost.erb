<% @vhosts.each do |server, port_config| %>
<% port_config.each do |port, config| %>
<%- config_merged = @vhost_defaults[port].merge(config) -%>
<VirtualHost *:<%= port %>>
 <% config_merged.each do |key, value| -%>
 <%- if key != 'Directory' -%>
 <%= key %> <%= value %>
 <%- else -%>
 <%- config_merged.each do |dir, dir_config| -%>
 <Directory "<%= dir %>">
   <%- dir_config.each do |x, y| -%>
   <%= x %> <%= y %>
   <%- end -%>
 <%- end -%>
 </Directory>
 <%- end -%>
 <%- end -%>
</VirtualHost>
<% end %>
<% end %>
